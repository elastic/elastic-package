version: '2.3'
services:
  apache:
    # Commented out `image:` below until we have a process to refresh the hosted images from
    # Dockerfiles in this repo. Until then, we build the image locally using `build:` below.
    # image: docker.elastic.co/integrations-ci/beats-apache:${SERVICE_VERSION:-2.4.20}-1
    build: .
    ports:
      - 80
    volumes:
      - ${SERVICE_LOGS_DIR}:/usr/local/apache2/logs
  custom-agent:
    hostname: custom-agent
    image: "docker.elastic.co/beats/elastic-agent-complete:8.2.0"
    healthcheck:
      test: "elastic-agent status"
      retries: 180
      interval: 1s
    environment:
      FLEET_ENROLL: "1"
      FLEET_INSECURE: "1"
      FLEET_URL: "http://fleet-server:8220"
    volumes:
      - ${SERVICE_LOGS_DIR}:/tmp/service_logs/
    depends_on:
      - apache
