version: '2.3'
services:
  nginx:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - 80
    volumes:
      - ${SERVICE_LOGS_DIR}:/var/log/nginx
    depends_on:
      terraform:
        condition: service_healthy
  terraform:
    tty: true
    stop_grace_period: 5m
    build:
      context: .
      dockerfile: Dockerfile.terraform
    environment:
      - TF_VAR_TEST_RUN_ID=${TEST_RUN_ID:-detached}
      - TF_VAR_CREATED_DATE=${CREATED_DATE:-unknown}
      - TF_VAR_BRANCH=${BRANCH_NAME_LOWER_CASE:-unknown}
      - TF_VAR_BUILD_ID=${BUILD_ID:-unknown}
      - TF_VAR_ENVIRONMENT=${ENVIRONMENT:-unknown}
      - TF_VAR_REPO=${REPO:-unknown}
      # Example to use credentials
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
      - AWS_PROFILE=${AWS_PROFILE}
      - AWS_REGION=${AWS_REGION:-us-east-1}
    volumes:
      - ./tf/:/stage/
      - ${SERVICE_LOGS_DIR}:/tmp/service_logs/
