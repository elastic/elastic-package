version: '2.3'
services:
  mongodb:
    build:
      context: .
      args:
        - SERVICE_VERSION=${SERVICE_VERSION:-7.0}
    ports:
      - 27017:27017
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand({serverStatus:1}).ok"]
      interval: 1s
      retries: 90
  mongodb-log:
    user: root
    build:
      context: .
      args:
        - SERVICE_VERSION=${SERVICE_VERSION:-7.0}
    volumes:
      - ${SERVICE_LOGS_DIR}:/var/log/mongodb
    entrypoint: >
      bash -c "chmod a+wx /var/log/mongodb && chmod a+r -R /var/log/mongodb && touch /var/log/mongodb/mongod.log && chmod 644 /var/log/mongodb/mongod.log && mongod --replSet beats --logpath /var/log/mongodb/mongod.log --logappend"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand({serverStatus:1}).ok"]
      interval: 1s
      retries: 90

