env:
  SETUP_GVM_VERSION: 'v0.5.2' # https://github.com/andrewkroh/gvm/issues/44#issuecomment-1013231151
  ELASTIC_PACKAGE_COMPOSE_DISABLE_VERBOSE_OUTPUT: "true"
  DOCKER_COMPOSE_VERSION: "v2.24.1"
  DOCKER_VERSION: "26.1.0"
  KIND_VERSION: 'v0.20.0'
  K8S_VERSION: 'v1.29.0'
  LINUX_AGENT_IMAGE: "golang:${GO_VERSION}"

steps:
  - input: "Input values for the variables"
    key: "input-variables"
    fields:
    - select: "SERVERLESS_PROJECT"
      key: "SERVERLESS_PROJECT"
      options:
        - label: "observability"
          value: "observability"
        - label: "security"
          value: "security"
      default: "observability"
    if: "build.source == 'ui'"

  - wait: ~
    if: "build.source == 'ui'"
    allow_dependency_failure: false

  - label: ":go: Run check-static"
    key: check-static
    command: "make check-static"
    agents:
      image: "${LINUX_AGENT_IMAGE}"
      cpu: "8"
      memory: "4G"

  - label: ":go: :linux: Run unit tests"
    key: unit-tests-linux
    command: "make test-go-ci"
    artifact_paths:
      - "build/test-results/*.xml"
      - "build/test-coverage/*.xml"
    agents:
      image: "${LINUX_AGENT_IMAGE}"
      cpu: "8"
      memory: "4G"

  - wait: ~
    continue_on_failure: true

  - label: ":pipeline: Test Serverless Integration tests"
    key: test-serverless
    command: ".buildkite/scripts/test_packages_with_serverless.sh"
    env:
      SERVERLESS_PROJECT: "${SERVERLESS_PROJECT:-observability}"
      UPLOAD_SAFE_LOGS: 1
    artifact_paths:
      - build/test-results/*.xml
      - build/test-coverage/coverage-*.xml
    depends_on:
      - step: check-static
        allow_failure: false
      - step: unit-tests-linux
        allow_failure: false

  - wait: ~
    continue_on_failure: true

  - label: ":junit: Junit annotate"
    plugins:
      - junit-annotate#v2.4.1:
          artifacts: "build/test-results/*.xml"
    agents:
      provider: "gcp"  # junit plugin requires docker
